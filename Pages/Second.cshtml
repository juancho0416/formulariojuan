@page
@model form.Pages.SecondModel
@{
    ViewData["Title"] = "Formulario con Código Postal";
}

<h2>Formulario</h2>
<hr class="red">
</hr>

<form method="post" id="mainForm">
    <div class="mb-3">
        <label asp-for="Input.Nombre" class="form-label">Nombre del titular</label>
        <input asp-for="Input.Nombre" class="form-control" type="text" placeholder="Ingrese el nombre del titular" />
        <span asp-validation-for="Input.Nombre" class="text-danger"></span>
        <hr>
        </hr>
    </div>


    <div class="row">

        <div class="col-md-6">

            <div class="mb-3">
                <label asp-for="Input.RFC" class="form-label">RFC</label>
                <input asp-for="Input.RFC" class="form-control" type="text" placeholder="Ingrese RFC " />
                <span asp-validation-for="Input.RFC" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Input.CURP" class="form.label">CURP</label>
                <input asp-for="Input.CURP" class="form-control" type="text" placeholder="Ingrese CURP" />
                <span asp-validation-for="Input.CURP" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="Input.Telefono" class="form-label">Telefono</label>
                <input asp-for="Input.Telefono" class="form-control" type="text"
                    placeholder="Ingrese su numero de telefono" />
                <span asp-validation-for="Input.Telefono" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="Input.Folio" class="form-label">Folio</label>
                <input asp-for="Input.Folio" class="form-control" type="text"
                    placeholder="Ingrese su numero de folio" />
                <span asp-validation-for="Input.Folio" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="Input.RazonSocial" class="form-label">Denominacion o razon social</label>
                <input asp-for="Input.RazonSocial" class="form-control" type="text"
                    placeholder="Ingrese denominacion o razon social" />
                <span asp-validation-for="Input.RazonSocial" class="text-danger"></span>
            </div>
        </div>


        <div class="col-md-6">

            <div class="mb-3">
                <label asp-for="Input.Calle" class="form-label">Calle</label>
                <input asp-for="Input.Calle" class="form-control" type="text"
                    placeholder="Ingrese nombre de la calle" />
                <span asp-validation.for="Input.Calle" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="Input.Numero" class="form-label">Numero</label>
                <input asp-for="Input.Numero" class="form-control" type="text"
                    placeholder="Ingrese el numero del domicilio" />
                <span asp-validation-for="Input.Numero" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="CodigoPostal" class="form-label">Código postal</label>
                <input asp-for="CodigoPostal" class="form-control" id="Input_CodigoPostal" type="text"
                    placeholder="Ingrese su codigo postal" />
                <span id="cpError" class="text-danger"></span>
            </div>
            <!-- Estado (readonly) -->
            <div class="mb-3" id="estadoContainer" style="display:none;">
                <label asp-for="Input.Estado" class="form-label">Estado</label>
                <input asp-for="Input.Estado" class="form-control" id="Input_Estado" readonly />
            </div>

            <!-- Municipio (select) -->
            <div class="mb-3" id="municipioContainer" style="display:none;">
                <label asp-for="Input.Municipio" class="form-label">Municipio</label>
                <select asp-for="Input.Municipio" class="form-select" id="Input_Municipio">
                    <option value="">--Seleccione un municipio--</option>
                </select>
                <span asp-validation-for="Input.Municipio" class="text-danger"></span>
            </div>
        </div>
    </div>


    @* <!-- campos -->
    <button type="submit" asp-page-handler="Enviar" class="btn btn-primary">Enviar</button>
    <button type="submit" asp-page-handler="Volver" class="btn btn-secondary">Volver</button> *@
    <button type="submit" class="btn btn-primary">Enviar</button>
    <a asp-page="/Index" class="btn btn-secondary">Volver</a>


</form>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const cpInput = document.getElementById('Input_CodigoPostal');
            const cpError = document.getElementById('cpError');
            const estadoContainer = document.getElementById('estadoContainer');
            const municipioContainer = document.getElementById('municipioContainer');
            const estadoInput = document.getElementById('Input_Estado');
            const municipioSelect = document.getElementById('Input_Municipio');

            async function fetchPostal(cp) {
                cpError.textContent = '';
                estadoContainer.style.display = 'none';
                municipioContainer.style.display = 'none';
                estadoInput.value = '';
                municipioSelect.innerHTML = '<option value="">--Seleccione un municipio--</option>';

                if (!cp) return;

                try {
                    const res = await fetch(`?handler=FetchPostal&codigoPostal=${encodeURIComponent(cp)}`);
                    const json = await res.json();
                    if (json.ok) {
                        estadoInput.value = json.state || '';
                        estadoContainer.style.display = 'block';
                        municipioContainer.style.display = 'block';
                        // poblar municipios
                        (json.municipios || []).forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m;
                            opt.textContent = m;
                            municipioSelect.appendChild(opt);
                        });
                        // Si solo hay 1 municipio selecciónala
                        if (json.municipios && json.municipios.length === 1) {
                            municipioSelect.value = json.municipios[0];
                        }
                    } else {
                        cpError.textContent = json.error || 'No se encontró código postal';
                    }
                } catch (e) {
                    cpError.textContent = 'Error al consultar el código postal';
                }
            }

            // Disparar al perder el foco o al cambiar valor
            cpInput.addEventListener('blur', () => fetchPostal(cpInput.value.trim()));
            cpInput.addEventListener('change', () => fetchPostal(cpInput.value.trim()));

            // Si el servidor ya retornó estado/municipio en la primera carga (por ejemplo al volver)
            document.addEventListener('DOMContentLoaded', function () {
                const cpVal = cpInput.value.trim();
                if (cpVal) {
                    fetchPostal(cpVal);
                }
            });
        })();
    </script>
}